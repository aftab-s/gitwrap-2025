# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - master
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Load .env into environment (if present)
        run: |
          if [ -f .env ]; then
            echo "Loading .env into environment"
            # Skip comments and empty lines, append to GITHUB_ENV so subsequent steps can use them
            grep -v '^\s*#' .env | sed '/^\s*$/d' | while IFS= read -r line; do echo "$line" >> $GITHUB_ENV; done
          else
            echo ".env not found, skipping"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Fetch repository contributors
        run: |
          mkdir -p public
          # Prefer the repository secret `VITE_GITHUB_APP_TOKEN` (from repo secrets), fall back to the runner's GITHUB_TOKEN
          TOKEN="${{ secrets.VITE_GITHUB_APP_TOKEN }}"
          if [ -z "$TOKEN" ] && [ -n "$GITHUB_TOKEN" ]; then
            TOKEN="$GITHUB_TOKEN"
          fi
          if [ -n "$TOKEN" ]; then
            echo "Fetching contributors with token from environment"
            curl -sSL -H "Accept: application/vnd.github+json" -H "Authorization: token $TOKEN" "https://api.github.com/repos/${GITHUB_REPOSITORY:-${{ github.repository }}}/contributors?per_page=100" > public/contributors.json || true
          else
            echo "No token found in environment, fetching unauthenticated (rate-limited)"
            curl -sSL -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${{ github.repository }}/contributors?per_page=100" > public/contributors.json || true
          fi

      - name: Build
        run: npm run build

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.VITE_GITHUB_APP_TOKEN || github.token }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PORTFOLIO_V1_F2BDD }}
          channelId: live
          projectId: portfolio-v1-f2bdd
